name: Auto Approve Workflow Runs

on:
  schedule:
    # Run every 5 minutes
    - cron: '*/5 * * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  auto-approve:
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Auto approve pending workflow runs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.OAUTH_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            
            // Get pending workflow runs that need approval
            const { data: pendingRuns } = await github.rest.actions.listWorkflowRunsForRepo({
              owner,
              repo,
              status: 'action_required',
            });
            
            console.log(`Found ${pendingRuns.total_count} pending workflow runs`);
            
            for (const run of pendingRuns.workflow_runs) {
              try {
                // Try to approve (works for fork PRs)
                await github.rest.actions.approveWorkflowRun({
                  owner,
                  repo,
                  run_id: run.id,
                });
                console.log(`Approved workflow run: ${run.id} (${run.name})`);
              } catch (error) {
                // For non-fork PRs, rerun the workflow instead
                if (error.message.includes('not from a fork pull request')) {
                  try {
                    await github.rest.actions.reRunWorkflow({
                      owner,
                      repo,
                      run_id: run.id,
                    });
                    console.log(`Reran workflow run: ${run.id} (${run.name})`);
                  } catch (rerunError) {
                    console.error(`Failed to rerun ${run.id}: ${rerunError.message}`);
                  }
                } else {
                  console.error(`Failed to approve run ${run.id}: ${error.message}`);
                }
              }
            }

      - name: Approve pending deployments
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.OAUTH_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            
            // Get workflow runs waiting for approval
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner,
              repo,
              status: 'waiting',
            });
            
            console.log(`Found ${runs.total_count} workflow runs waiting for deployment approval`);
            
            for (const run of runs.workflow_runs) {
              try {
                const { data: deployments } = await github.rest.actions.getPendingDeploymentsForRun({
                  owner,
                  repo,
                  run_id: run.id,
                });
                
                if (deployments.length > 0) {
                  const environmentIds = deployments.map(d => d.environment.id);
                  
                  await github.rest.actions.reviewPendingDeploymentsForRun({
                    owner,
                    repo,
                    run_id: run.id,
                    environment_ids: environmentIds,
                    state: 'approved',
                    comment: 'Auto-approved by workflow',
                  });
                  
                  console.log(`Approved deployments for run ${run.id}: ${environmentIds.join(', ')}`);
                }
              } catch (error) {
                console.error(`Failed to process deployments for run ${run.id}: ${error.message}`);
              }
            }

